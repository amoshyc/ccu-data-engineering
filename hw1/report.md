# 作業一報告

403410034 資工四 黃鈺程

## 作業內容

實現一個基於網頁介面的文檔搜尋程式。
給定 10 萬筆的詞，2GB 的資料，輸出各個詞在資料中的出現次數或位置。
保證詞的長度為 2 ~ 7，詞與資料都為中英文混雜，utf-8 編碼。

搜尋滿足：

1. 最長匹配：例如詞為「我」、「我是」，那資料中的「我是誰」只計入「我是」的統計。
2. 第一匹配：例如詞為「行列」、「列行」，資料中的「行列行」只計入「行列」的統計。

## UI

![Imgur](https://i.imgur.com/eozA8Fd.png)

![Imgur](https://i.imgur.com/Zumo1H4.png)

![Imgur](https://i.imgur.com/M2JoD8y.png)

![Imgur](https://i.imgur.com/yNWWtgI.png)

![Imgur](https://i.imgur.com/9rzxy1l.png)

UI 的特色為：

1. 文字高亮標記
2. 前 10 出現次數統計圖表
3. 可以輸入檔案路徑
4. 可以設定搜尋參數
5. 基於我 blog theme zmd 的配色

使用的技術或函式庫有：

1. Html 5 `<mark>`
2. Chart.js
3. MDL
4. signal/slot design pattern
5. JQuery

各檔案最終行數統計為

1. HTML: 146 行
2. CSS: 146 行
3. JS: 293 行


## 演算法

我共寫了 4 種演算法，都是基於 ngrams，因為要用其他方法，例如 Aho–Corasick algorithm 實作出要求的最長匹配、第一匹配相對複雜。

我分別使用 Python 與 Go 實現有與沒有平行加速的 ngrams：

1. Python ngrams: `sp_py`
2. Python ngrams multiprocess: `mp_py`
3. Go ngrams: `st_py`
4. Go ngrams with routines: `mt_py`

在測試方面我使用了維基百科的中文資料，分別製做出了 10MB, 50MB, 100MB 的資料，加上同學的 500MB，共 4 個資料來做測試。term 使用同學的，共有個 83970 個詞。我的程式會找出各個 term 的 **出現位置** 不只是出現次數。所以 output 的檔案也是極大的，像是 500MB 的資料的輸出是 234MB。不過執行速度才是我們關注的：

| Dataset(MB) |  `sp_py`  |  `st_go`  |  `mp_py`  |  `mt_go`  |
| ----------- | --------- | --------- | --------- | --------- |
| 10	      | 10.4      | 1.6       |	10.8      |	1.4       |
| 50	      | 55.6      | 7.0       |	35.6      |	7.7       |
| 100	      | 99.0      | 15.1      |	72.7      |	13.6      |
| 500	      | 737.8     | 89.6      |	524.5     |	73.8      |

畫成圖表：

![Imgur](https://i.imgur.com/7Ld2YQj.png)


## 實作遇到的問題

### JS <-> Server 之間不同處理方法

server(torndo) 傳資料給 JS 時沒什麼問題，`str` 還是 `str`，`list` 變成 `Array`，`dict `變成 `Object`，都是正確的。但 JS 傳資料給 server 的就不是這樣，一切東西都變成 `str`，被這個坑到了。js 傳了一個變數值為 `false` 給 server，結果我在 server 執行 `if var: something`，注意 var 是字串 `'false'` 所以這個 if 永遠都會成立，我還想說這個變數怎麼不起作用。


### 演算法記憶體使用過多

使用 Python 的 `mp` 時，記多方法都會讓程式的記憶體用量爆增，通常是資料本身的 4x 以上。我的解決方法為使用自己分塊讀資料，並使用 `mp.Pool` 的 `imap` 來實現，記憶體即降到 1.5x ~ 2.0x。

實作 go 的 `go routines` 也是有同樣問題。我試了許多種實作方法，例如使用全域變數，或透過 `channel` 傳資料，都沒有解決。尚不清楚為什麼會這樣。

------------------

我一個猜測是 Go, Python 都是所謂的 GC 語言，會不會這些記憶體用量只是還沒回收呢？這個猜想還沒去驗證，我想到的驗證方法為在 docker 中跑這些程式，docker 可以限制記憶體用量。限制記憶體為一個較小的值，看看執行的速度是不是跟原本的一樣。如果那些記憶體是沒作用的，那執行時間應該會差不多，頂多加上一點的 GC 時間；如果是重要的資料，那程式應該會轉而使用 swap，造成程式變得極慢。


### Go routine 沒想像中快

可以從表格中知道，有沒有用 Go routine 的時間沒差太多，這讓我覺得 go routine 的效率沒想像中高，不過我在跑的時候，發現有沒有開，cpu 利用率是差很多的，所以我認為可能有三個理由：

1. 資料太小，用 2G, 4G 資料可能差距就很大
2. 傳參數、處理回傳值、開檔等操作主導了時間，而不是搜尋的部份
3. 我 Go routine 用錯了，造成應有的改進沒出來

--------

這次因為剛好在弄推甄資料，沒有太多時間做這個作業，所以留到下次再來調查吧。


## 心得

- 多語言混合使用，如果包含輸出結果的 json 格式，我共使用了 6 種語言：HTML, CSS, JS, Python, Go, JSON，這有時真讓人很混亂，尤其是我很久（應該有三年）沒寫 Go 了，語法不是很熟悉，在 coding 時很容易就有語法錯誤：`:=` 打成 `=`。

- signal/slot 的第一次實作，之前並不知道 js 中有一個 `apply` 的函式可以把 Array 轉成參數去做函式呼叫，效果類似於 Python 中的 `f(*args)`，造成我程式碼中的 signal/slot 只能傳遞一個參數。下次新專案或重構時得記得用 js 的不長度參數與 `apply` 來實作 signal/slot。

- MDL 中的 Grid Layout 沒有理想中那麼好排版，下次要記得「可以嵌套」或轉用 flex layout 自行排版

總而言之，這個專案讓我感到很滿意，總和了我之前的知識：網頁前端、網頁後端，並認真研究了 Python 的多進程、Golang。學到了許多東西。